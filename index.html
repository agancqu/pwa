<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <title>Robot Twin 3.8 Stable</title>
    <style>
        body { text-align: center; font-family: sans-serif; background: #f4f7f9; padding: 10px; margin: 0; }
        .card { background: white; border-radius: 15px; padding: 15px; margin: 10px auto; max-width: 420px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        canvas { background: #fff; border-radius: 10px; border: 1px solid #ccc; display: block; margin: 0 auto; max-width: 100%; height: auto; }
        .btn { background: #007AFF; color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .ble-btn { background: #5856D6; margin-bottom: 10px; }
        #status { font-weight: bold; color: #007AFF; margin-top: 10px; font-size: 14px; min-height: 20px; }
        .control-group { display: flex; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¨ ESP32 Robot 3.8</h2>
        <button id="connectBtn" class="btn ble-btn" onclick="connectBLE()">ğŸ“¡ è¿æ¥æœºå™¨äºº (Connect)</button>
        <div id="status">Ready</div>
        <hr>
        <canvas id="preview" width="300" height="300"></canvas>
        
        <input type="file" id="fileInput" accept=".gcode,.txt,.nc" style="display:none" onchange="handleFile(this.files[0])">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŠ è½½ G-Code æ–‡ä»¶</button>
        
        <div class="control-group">
            <button id="startBtn" class="btn" onclick="sendCommand('CMD:START')" disabled>â–¶ å¼€å§‹ç»˜ç”»</button>
            <button id="stopBtn" class="btn" style="background:#ff3b30" onclick="sendCommand('CMD:STOP')" disabled>â¸ æš‚åœ</button>
        </div>
        <div class="control-group">
            <button class="btn" style="background:#ff9500" onclick="sendCommand('CMD:SERVO_FWD')">âœï¸ è½ç¬”æµ‹è¯•</button>
            <button class="btn" style="background:#ff9500" onclick="sendCommand('CMD:SERVO_REV')">â¬†ï¸ æŠ¬ç¬”æµ‹è¯•</button>
        </div>
    </div>

    <script>
        // UUID å¿…é¡»å…¨å°å†™ï¼Œä¸ main.c ä¸­çš„å®šä¹‰ä¸€è‡´
        const SERVICE_UUID = '000000ff-0000-1000-8000-00805f9b34fb';
        const CHAR_CMD_UUID = '000000ff-0000-1000-8000-00805f9b3401';
        const CHAR_STAT_UUID = '000000ff-0000-1000-8000-00805f9b3402';

        let device, server, service, charCmd, charStat;
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const canvas = document.getElementById('preview');
        const ctx = canvas.getContext('2d');

        // ç»˜å›¾ç›¸å…³å˜é‡
        let curX=0, curY=0, isPenDown=false, autoScale=1.0; 
        let isM3=false; // åæ ‡ç³»ä¿®æ­£æ ‡å¿—

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        async function connectBLE() {
            try {
                statusDiv.innerText = "æ­£åœ¨æœç´¢è®¾å¤‡...";
                
                // [å…³é”®ä¿®æ”¹] ä½¿ç”¨ services è¿‡æ»¤ï¼Œè€Œä¸æ˜¯ name
                // è¿™æ ·èƒ½ç¡®ä¿åœ¨å¹¿æ’­åŒ…åªåŒ…å« UUID çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¢«å‘ç°
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID]
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                statusDiv.innerText = "æ­£åœ¨è¿æ¥...";
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);
                
                charCmd = await service.getCharacteristic(CHAR_CMD_UUID);
                charStat = await service.getCharacteristic(CHAR_STAT_UUID);

                await charStat.startNotifications();
                charStat.addEventListener('characteristicvaluechanged', handleStatusUpdate);

                statusDiv.innerText = "âœ… å·²è¿æ¥: " + device.name;
                document.getElementById('connectBtn').innerText = "å·²è¿æ¥ (ç‚¹å‡»æ–­å¼€)";
                document.getElementById('connectBtn').onclick = disconnectBLE;
                
            } catch (error) {
                console.error(error);
                // [æ–°å¢] å°†é”™è¯¯ç›´æ¥æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œæ–¹ä¾¿æ‰‹æœºè°ƒè¯•
                statusDiv.innerText = "è¿æ¥å¤±è´¥: " + error.message;
            }
        }

        function disconnectBLE() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }

        function onDisconnected() {
            statusDiv.innerText = "âŒ è®¾å¤‡å·²æ–­å¼€";
            document.getElementById('connectBtn').innerText = "ğŸ“¡ è¿æ¥æœºå™¨äºº";
            document.getElementById('connectBtn').onclick = connectBLE;
            startBtn.disabled = true;
            stopBtn.disabled = true;
        }

        async function sendCommand(cmd) {
            if (!charCmd) return;
            try {
                const encoder = new TextEncoder();
                await charCmd.writeValue(encoder.encode(cmd));
                console.log("Sent:", cmd);
            } catch (e) {
                statusDiv.innerText = "å‘é€å¤±è´¥: " + e.message;
            }
        }

        function handleStatusUpdate(event) {
            const value = event.target.value;
            const decoder = new TextDecoder();
            const jsonStr = decoder.decode(value);
            try {
                // ç®€å•è§£æ JSON: {"s":1,"p":50,"c":"G1 X10 Y10"}
                const data = JSON.parse(jsonStr);
                let stateText = ["ç©ºé—²", "ç»˜ç”»ä¸­", "æš‚åœ", "å®Œæˆ"][data.s] || "æœªçŸ¥";
                statusDiv.innerText = `çŠ¶æ€: ${stateText} | è¿›åº¦: ${data.p}%`;
            } catch (e) {
                console.log("Parse Error", jsonStr);
            }
        }

        async function handleFile(file) {
            if (!file) return;
            statusDiv.innerText = "æ­£åœ¨è§£æ G-Code...";
            const text = await file.text();
            
            // 1. æœ¬åœ°é¢„è§ˆ
            ctx.clearRect(0,0,300,300);
            calculateScale(text);
            ctx.beginPath();
            curX=0; curY=0; isPenDown=false;
            text.split('\n').forEach(line => parseAndDraw(line));
            
            // 2. å‘é€æ–‡ä»¶åˆ° ESP32 (åˆ†ç‰‡å‘é€)
            if (charCmd) {
                statusDiv.innerText = "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...";
                await sendCommand("CMD:NEWFILE");
                const lines = text.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.length > 0) {
                        await sendCommand(line + "\n");
                        // ç®€å•æµæ§ï¼šæ¯å‘å‡ è¡Œæš‚åœä¸€ä¸‹ï¼Œé˜²æ­¢é˜»å¡
                        if (i % 10 === 0) await new Promise(r => setTimeout(r, 20)); 
                        statusDiv.innerText = `ä¸Šä¼ ä¸­: ${Math.round(i/lines.length*100)}%`;
                    }
                }
                statusDiv.innerText = "æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œè¯·ç‚¹å‡»å¼€å§‹";
                startBtn.disabled = false;
                stopBtn.disabled = false;
            } else {
                statusDiv.innerText = "é¢„è§ˆå®Œæˆ (æœªè¿æ¥è®¾å¤‡)";
            }
        }

        // --- ç®€å•çš„ G-Code é¢„è§ˆé€»è¾‘ ---
        function calculateScale(content) {
            let mX=0, mY=0; 
            isM3 = content.includes('M3'); // åˆ¤æ–­æ˜¯å¦ä¸ºæ¿€å…‰/èˆµæœºæ¨¡å¼
            content.split('\n').forEach(l=>{
                const x=l.match(/X([\d.]+)/), y=l.match(/Y([\d.]+)/);
                if(x) mX=Math.max(mX,parseFloat(x[1])); 
                if(y) mY=Math.max(mY,parseFloat(y[1]));
            });
            // è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº” 300x300 ç”»å¸ƒ
            autoScale = Math.max(mX,mY) > 0 ? (280/Math.max(mX,mY)) : 1.0;
        }

        function parseAndDraw(cmd) {
            let nX=curX, nY=curY;
            // ç®€å•æ¨¡æ‹Ÿ M3/M5 è½ç¬”æŠ¬ç¬”
            if(cmd.includes('M3')) isPenDown=true; 
            if(cmd.includes('M5')) isPenDown=false;
            
            const x=cmd.match(/X([\d.]+)/), y=cmd.match(/Y([\d.]+)/), z=cmd.match(/Z([\d.]+)/);
            
            if(x) nX=parseFloat(x[1]) * autoScale; 
            if(y) nY=parseFloat(y[1]) * autoScale;
            if(z) isPenDown=(parseFloat(z[1]) <= 0); // å‡è®¾ Z<=0 æ˜¯è½ç¬”

            if(cmd.includes('G0') || cmd.includes('G1')){
                // åæ ‡è½¬æ¢ï¼šåŠ ç‚¹è¾¹è·
                let drawX = nX + 10;
                let drawY = isM3 ? (290 - nY) : (nY + 10); // é•œåƒYè½´å¦‚æœéœ€è¦

                if(isPenDown){ 
                    ctx.lineTo(drawX, drawY); 
                    ctx.stroke(); 
                } else { 
                    ctx.moveTo(drawX, drawY); 
                }
                curX=nX; curY=nY;
            }
        }
    </script>
</body>
</html>